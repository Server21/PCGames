<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bonazza - PTLANCHER</title>
  <link id="dynamic-favicon" rel="icon" href="https://i.postimg.cc/XYfBdscq/icon.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #4caf50;
      --secondary-color: #2196f3;
      --error-color: #f44336;
      --text-color: #fff;
      --bg-color: #2c3e50;
      --container-bg: #ffffff;
      --font-family: 'Roboto', sans-serif;
      --input-border: #ccc;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-family);
      background: var(--bg-color);
      color: var(--text-color);
    }
    .banner {
      width: 100%;
    }
    .banner img {
      width: 100%;
      height: auto;
      display: block;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      padding: 1rem;
    }
    .account-info {
      margin-bottom: 1rem;
      text-align: right;
      font-weight: 500;
    }
    .account-info a {
      text-decoration: none;
      font-weight: 500;
    }
    .search-bar {
      margin-bottom: 1rem;
    }
    .search-bar input {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }
    .tag-filter {
      margin-bottom: 1rem;
    }
    .tag-filter label {
      font-size: 1rem;
      margin-right: 0.5rem;
      font-weight: 500;
    }
    .tag-filter select {
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }
    .games-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }
    .game-card {
      background-color: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    .game-card:hover { transform: scale(1.02); }
    .game-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }
    .game-card .content {
      padding: 1rem;
      color: #333;
    }
    .game-card h3 {
      margin: 0 0 0.5rem;
      font-size: 1.25rem;
      color: #333;
    }
    .game-card p {
      font-size: 0.9rem;
      line-height: 1.4;
      color: #666;
    }
    .tags {
      margin: 0.5rem 0;
    }
    .tag {
      display: inline-block;
      background-color: #e0e0e0;
      color: #555;
      padding: 0.25rem 0.5rem;
      margin-right: 0.3rem;
      border-radius: 4px;
      font-size: 0.8rem;
    }
    .download-btn {
      display: inline-block;
      margin-top: 0.5rem;
      padding: 0.5rem 1rem;
      background-color: var(--primary-color);
      color: #fff;
      text-decoration: none;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    .download-btn:hover { background-color: #45a049; }
    .logout-btn {
      background-color: var(--error-color);
      color: #fff;
      padding: 0.5rem 1rem;
      text-decoration: none;
      border-radius: 4px;
      transition: background-color 0.3s;
      font-weight: 500;
    }
    .logout-btn:hover { background-color: #d32f2f; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Banner -->
    <div class="banner">
      <img src="https://raw.githubusercontent.com/Server21/PCGames/refs/heads/main/Best/banner.png" alt="Banner PTLANCHER">
    </div>
    <div class="account-info" id="account-info">
      <!-- Le informazioni dell'account verranno visualizzate qui -->
    </div>
    <div class="search-bar">
      <input type="text" id="search-input" placeholder="Cerca giochi per nome, descrizione o lingua...">
    </div>
    <div class="tag-filter">
      <label for="tag-filter-select">Filtra per tag:</label>
      <select id="tag-filter-select">
        <option value="">Tutti</option>
        <!-- Opzioni aggiunte dinamicamente -->
      </select>
    </div>
    <div class="games-grid" id="games-grid">
      <!-- I giochi verranno caricati dinamicamente -->
    </div>
  </div>
  <script>
    // Funzione per calcolare i mesi mancanti dall'abbonamento
    function calcolaMesiMancanti(expiryDate) {
      const now = new Date();
      const expire = new Date(expiryDate);
      let months = (expire.getFullYear() - now.getFullYear()) * 12 + (expire.getMonth() - now.getMonth());
      if(expire.getDate() < now.getDate()) months--;
      return months < 0 ? 0 : months;
    }
    
    // Visualizza le informazioni dell'account
    function mostraAccountInfo(user) {
      const accountInfoDiv = document.getElementById("account-info");
      let infoHtml = `<span>Benvenuto, <strong>${user.username}</strong></span>`;
      if (user.expires) {
        const mesiMancanti = calcolaMesiMancanti(user.expires);
        infoHtml += ` | Abbonamento scade tra ${mesiMancanti} mese${mesiMancanti !== 1 ? "i" : ""}`;
        if (mesiMancanti <= 1)
          infoHtml += ` <a href="login.html" style="color:red;">Rinnova abbonamento</a>`;
      } else {
        infoHtml += ` | <a href="login.html" style="color:red;">Attiva abbonamento</a>`;
      }
      infoHtml += ` | <a href="#" id="logout" class="logout-btn">Logout</a>`;
      accountInfoDiv.innerHTML = infoHtml;
      
      // Gestione del logout
      document.getElementById("logout").addEventListener("click", function(e) {
        e.preventDefault();
        localStorage.removeItem("loggedInUser");
        sessionStorage.removeItem("loggedInUser");
        window.location.href = "login.html";
      });
    }
    
    // Funzioni per visualizzare e filtrare i giochi
    function displayGames(games) {
      const grid = document.getElementById("games-grid");
      grid.innerHTML = "";
      games.forEach(game => {
        const card = document.createElement("div");
        card.className = "game-card";
        card.innerHTML = `
          <img src="${game.image_url}" alt="${game.name}">
          <div class="content">
            <h3>${game.name}</h3>
            <p>${game.description}</p>
            <div class="tags">
              ${game.category.map(cat => `<span class="tag">${cat}</span>`).join(" ")}
            </div>
            <a href="${game.download_link}" class="download-btn" download>Download</a>
          </div>
        `;
        grid.appendChild(card);
      });
    }
    
    function debounce(func, delay) {
      let timer;
      return function(...args) {
        clearTimeout(timer);
        timer = setTimeout(() => {
          func.apply(this, args);
        }, delay);
      };
    }
    
    function applyFilters(games) {
      const query = document.getElementById("search-input").value.trim().toLowerCase();
      const selectedTag = document.getElementById("tag-filter-select").value;
      return games.filter(game => {
        let matchesSearch = true;
        if (query) {
          matchesSearch =
            (game.name && game.name.toLowerCase().includes(query)) ||
            (game.description && game.description.toLowerCase().includes(query)) ||
            (game.languages && game.languages.some(lang => lang.toLowerCase().includes(query)));
        }
        let matchesTag = true;
        if (selectedTag) {
          matchesTag = game.category && game.category.includes(selectedTag);
        }
        return matchesSearch && matchesTag;
      });
    }
    
    let allGames = [];
    
    function populateTagFilter(games) {
      const tagSelect = document.getElementById("tag-filter-select");
      const tagsSet = new Set();
      games.forEach(game => {
        if (Array.isArray(game.category)) {
          game.category.forEach(tag => tagsSet.add(tag));
        }
      });
      const tags = Array.from(tagsSet).sort();
      tags.forEach(tag => {
        const option = document.createElement("option");
        option.value = tag;
        option.textContent = tag;
        tagSelect.appendChild(option);
      });
    }
    
    async function fetchVersionInfo() {
      try {
        const response = await fetch("https://raw.githubusercontent.com/Server21/PCGames/refs/heads/main/version.json");
        if (!response.ok) throw new Error("Errore nel caricamento delle info di versione");
        const versionData = await response.json();
        updateFavicon(versionData);
      } catch (error) {
        console.error(error);
      }
    }
    
    function updateFavicon(versionData) {
      if (versionData && versionData.icon_link) {
        let favicon = document.getElementById("dynamic-favicon");
        if (!favicon) {
          favicon = document.createElement("link");
          favicon.id = "dynamic-favicon";
          favicon.rel = "icon";
          document.head.appendChild(favicon);
        }
        favicon.href = versionData.icon_link;
      }
    }
    
    // Funzione per ottenere l'utente loggato
    function getLoggedInUser() {
      const data = localStorage.getItem("loggedInUser") || sessionStorage.getItem("loggedInUser");
      return data ? JSON.parse(data) : null;
    }
    
    // Funzione per caricare gli account (se necessaria)
    async function fetchAccounts() {
      try {
        const response = await fetch("https://raw.githubusercontent.com/Server21/PCGames/refs/heads/main/accounts.json");
        if (!response.ok) throw new Error("Errore nel caricamento degli account");
        const accountsData = await response.json();
        return accountsData;
      } catch (error) {
        console.error("Errore nel caricamento degli account:", error);
      }
    }
    
    async function init() {
      // Controlla se esiste un utente loggato; se non c'è, reindirizza a login.html
      let user = getLoggedInUser();
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      // Se l'utente è loggato, mostra le sue informazioni
      mostraAccountInfo(user);
      
      try {
        const response = await fetch("https://raw.githubusercontent.com/Server21/PCGames/refs/heads/main/games.json");
        if (!response.ok) throw new Error("Errore nel caricamento dei giochi");
        const games = await response.json();
        allGames = games;
        displayGames(allGames);
        populateTagFilter(allGames);
        
        const runFilters = debounce(() => {
          const filtered = applyFilters(allGames);
          displayGames(filtered);
        }, 300);
        
        document.getElementById("search-input").addEventListener("input", runFilters);
        document.getElementById("tag-filter-select").addEventListener("change", runFilters);
      } catch(error) {
        console.error(error);
        document.getElementById("games-grid").innerText = "Errore nel caricamento dei giochi.";
      }
      
      await fetchAccounts();
      await fetchVersionInfo();
    }
    
    document.addEventListener("DOMContentLoaded", init);
    
    // Eventuale gestione dei click sugli anchor per navigazione interna (assicurati che non reindirizzi in loop)
    document.addEventListener('click', function(event) {
      const anchor = event.target.closest('a');
      if (anchor && anchor.href) {
        // Se l'anchor punta alla pagina corrente, non fare nulla
        if (anchor.href === window.location.href) return;
        // Altrimenti reindirizza normalmente
        event.preventDefault();
        window.location.href = anchor.href;
      }
    });
  </script>
</body>
</html>
