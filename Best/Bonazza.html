<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bonazza - Catalogo Giochi</title>
    <!-- Favicon dinamico -->
    <link id="dynamic-favicon" rel="icon" href="https://i.postimg.cc/XYfBdscq/icon.png" type="image/png" />
    <style>
      /* Stili moderni, responsive e minimal */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f2f2f2;
        margin: 0;
        padding: 0;
        color: #333;
      }
      header {
        background-color: #4caf50;
        color: white;
        padding: 1rem;
        text-align: center;
      }
      .container {
        max-width: 1200px;
        margin: auto;
        padding: 1rem;
      }
      .account-info {
        margin-bottom: 1rem;
        text-align: right;
        font-weight: 600;
      }
      /* Sezione per la ricerca testuale */
      .search-bar {
        margin-bottom: 1rem;
      }
      .search-bar input {
        width: 100%;
        padding: 0.7rem;
        font-size: 1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      /* Sezione filtro per i tag */
      .tag-filter {
        margin-bottom: 1rem;
      }
      .tag-filter label {
        font-size: 1rem;
        margin-right: 0.5rem;
        font-weight: 600;
      }
      .tag-filter select {
        padding: 0.5rem;
        font-size: 1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .games-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
      }
      .game-card {
        background-color: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }
      .game-card:hover {
        transform: scale(1.02);
      }
      .game-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
      }
      .game-card .content {
        padding: 1rem;
      }
      .game-card h3 {
        margin: 0 0 0.5rem 0;
      }
      .game-card p {
        font-size: 0.9rem;
        line-height: 1.4;
      }
      .tags {
        margin: 0.5rem 0;
      }
      .tag {
        display: inline-block;
        background-color: #e0e0e0;
        color: #555;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        margin-right: 0.3rem;
      }
      .download-btn {
        display: inline-block;
        margin-top: 0.5rem;
        padding: 0.5rem 1rem;
        background-color: #4caf50;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        transition: background-color 0.3s;
      }
      .download-btn:hover {
        background-color: #45a049;
      }
      .logout-btn {
        background-color: #f44336;
        color: white;
        padding: 0.5rem 1rem;
        text-decoration: none;
        border-radius: 4px;
        transition: background-color 0.3s;
        font-weight: 600;
      }
      .logout-btn:hover {
        background-color: #d32f2f;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Catalogo Giochi</h1>
    </header>
    <div class="container">
      <div class="account-info" id="account-info">
        <!-- Le informazioni dell'account verranno visualizzate qui -->
      </div>
      <!-- Box per la ricerca testuale -->
      <div class="search-bar">
        <input type="text" id="search-input" placeholder="Cerca giochi per nome, descrizione o lingua..." />
      </div>
      <!-- Filtro per tag: seleziona da una lista -->
      <div class="tag-filter">
        <label for="tag-filter-select">Filtra per tag:</label>
        <select id="tag-filter-select">
          <option value="">Tutti</option>
          <!-- Le opzioni verranno aggiunte dinamicamente -->
        </select>
      </div>
      <div class="games-grid" id="games-grid">
        <!-- I giochi verranno caricati dinamicamente -->
      </div>
    </div>

    <script>
      // Aggiorna dinamicamente il favicon utilizzando version.json
      async function fetchVersionInfo() {
        try {
          const response = await fetch("https://raw.githubusercontent.com/Server21/PCGames/refs/heads/main/version.json");
          if (!response.ok) throw new Error("Errore nel caricamento delle info di versione");
          const versionData = await response.json();
          updateFavicon(versionData);
        } catch (error) {
          console.error(error);
        }
      }
      
      function updateFavicon(versionData) {
        if (versionData && versionData.icon_link) {
          let favicon = document.getElementById("dynamic-favicon");
          if (!favicon) {
            favicon = document.createElement("link");
            favicon.id = "dynamic-favicon";
            favicon.rel = "icon";
            document.head.appendChild(favicon);
          }
          favicon.href = versionData.icon_link;
        }
      }

      // Calcola i mesi mancanti dalla scadenza
      function calcolaMesiMancanti(expiryDate) {
        const now = new Date();
        const expire = new Date(expiryDate);
        let months = (expire.getFullYear() - now.getFullYear()) * 12 + (expire.getMonth() - now.getMonth());
        if (expire.getDate() < now.getDate()) months--;
        return months < 0 ? 0 : months;
      }

      // Visualizza le informazioni dell'account nell'header
      function mostraAccountInfo(loggedInUser) {
        const accountInfoDiv = document.getElementById("account-info");
        let infoHtml = `<span>Benvenuto, <strong>${loggedInUser.username}</strong></span>`;
        if (loggedInUser.expires) {
          const mesiMancanti = calcolaMesiMancanti(loggedInUser.expires);
          infoHtml += ` | Abbonamento scade tra ${mesiMancanti} mese${mesiMancanti !== 1 ? "i" : ""}`;
          if (mesiMancanti <= 1)
            infoHtml += ` <a href="login.html" style="color:red;">Rinnova abbonamento</a>`;
        } else {
          infoHtml += ` | <a href="login.html" style="color:red;">Attiva abbonamento</a>`;
        }
        infoHtml += ` | <a href="#" id="logout" class="logout-btn">Logout</a>`;
        accountInfoDiv.innerHTML = infoHtml;
      }

      // Visualizza i giochi in griglia
      function displayGames(games) {
        const grid = document.getElementById("games-grid");
        grid.innerHTML = "";
        games.forEach((game) => {
          const card = document.createElement("div");
          card.className = "game-card";
          card.innerHTML = `
            <img src="${game.image_url}" alt="${game.name}" />
            <div class="content">
              <h3>${game.name}</h3>
              <p>${game.description}</p>
              <div class="tags">
                ${game.category.map(cat => `<span class="tag">${cat}</span>`).join(" ")}
              </div>
              <a href="${game.download_link}" class="download-btn" target="_blank">Download</a>
            </div>
          `;
          grid.appendChild(card);
        });
      }

      // Funzione debounce per ottimizzare il filtraggio
      function debounce(func, delay) {
        let timer;
        return function (...args) {
          clearTimeout(timer);
          timer = setTimeout(() => {
            func.apply(this, args);
          }, delay);
        };
      }

      // Funzione che applica i filtri (ricerca + tag) sui giochi
      function applyFilters(games) {
        const query = document.getElementById("search-input").value.trim().toLowerCase();
        const selectedTag = document.getElementById("tag-filter-select").value;
        return games.filter(game => {
          let matchesSearch = true;
          if (query) {
            matchesSearch =
              (game.name && game.name.toLowerCase().includes(query)) ||
              (game.description && game.description.toLowerCase().includes(query)) ||
              (game.languages && game.languages.some(lang => lang.toLowerCase().includes(query)));
          }
          let matchesTag = true;
          if (selectedTag) {
            matchesTag = game.category && game.category.includes(selectedTag);
          }
          return matchesSearch && matchesTag;
        });
      }

      let allGames = [];

      // Popola il dropdown con i tag unici provenienti dai giochi
      function populateTagFilter(games) {
        const tagSelect = document.getElementById("tag-filter-select");
        // Crea un insieme per raccogliere tag unici
        const tagsSet = new Set();
        games.forEach(game => {
          if (Array.isArray(game.category)) {
            game.category.forEach(tag => tagsSet.add(tag));
          }
        });
        // Ordina i tag (opzionale)
        const tags = Array.from(tagsSet).sort();
        // Aggiungi le opzioni al dropdown
        tags.forEach(tag => {
          const option = document.createElement("option");
          option.value = tag;
          option.textContent = tag;
          tagSelect.appendChild(option);
        });
      }

      // Funzione di inizializzazione della pagina
      async function init() {
        // Controlla se esiste una sessione attiva
        const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
        if (!loggedInUser) {
          window.location.href = "login.html";
          return;
        }
        mostraAccountInfo(loggedInUser);

        // Gestore logout
        document.getElementById("logout").addEventListener("click", (e) => {
          e.preventDefault();
          localStorage.removeItem("loggedInUser");
          window.location.href = "login.html";
        });

        // Carica i giochi dal repository remoto
        try {
          const response = await fetch("https://raw.githubusercontent.com/Server21/PCGames/refs/heads/main/games.json");
          if (!response.ok) throw new Error("Errore nel caricamento dei giochi");
          const games = await response.json();
          allGames = games;
          displayGames(allGames);
          populateTagFilter(allGames);

          // Applica il filtraggio sia per ricerca che per tag
          const runFilters = debounce(() => {
            const filtered = applyFilters(allGames);
            displayGames(filtered);
          }, 300);

          document.getElementById("search-input").addEventListener("input", runFilters);
          document.getElementById("tag-filter-select").addEventListener("change", runFilters);
        } catch (error) {
          console.error(error);
          document.getElementById("games-grid").innerText = "Errore nel caricamento dei giochi.";
        }

        // Aggiorna il favicon con i dati di version.json
        fetchVersionInfo();
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
